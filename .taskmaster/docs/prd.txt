# Product Requirements Document: Collaborative Whiteboard App

## Executive Summary

A real-time collaborative whiteboard application built with Excalidraw, enabling small teams to sketch, diagram, and brainstorm together. The app uses Supabase for authentication, data persistence, and real-time synchronization.

---

## Product Overview

### Problem Statement

Small teams need a simple, private whiteboard space where multiple people can draw and collaborate simultaneously without the complexity of enterprise tools or reliance on third-party services that may have privacy concerns.

### Solution

A self-hostable collaborative whiteboard app that provides:

- Real-time multi-user drawing on shared canvases
- Simple authentication to keep boards private to the team
- Persistent storage so work is never lost
- Minimal UI that stays out of the way

### Target Users

- Small teams (5-20 people)
- Trusted environment where all users can access all boards
- Technical teams comfortable with self-hosted solutions

---

## Technical Architecture

### Tech Stack

| Layer | Technology | Purpose |
|-------|------------|---------|
| Frontend | Next.js 14+ (App Router) | React framework with SSR |
| Canvas | @excalidraw/excalidraw | Whiteboard component |
| Auth | Supabase Auth | User authentication |
| Database | Supabase Postgres | Board storage |
| Realtime | Supabase Realtime | Live collaboration sync |
| Styling | Tailwind CSS | Minimal styling |
| Deployment | Docker / Vercel | Flexible hosting |

### System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Client Browser                        │
├─────────────────────────────────────────────────────────────┤
│  Next.js App                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  Auth Pages │  │  Dashboard  │  │  Board View         │  │
│  │  - Login    │  │  - List     │  │  - ExcalidrawWrapper│  │
│  │  (Magic Link)│  │  - Create   │  │  - PresenceAvatars  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Supabase                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │    Auth     │  │  Postgres   │  │     Realtime        │  │
│  │  - Magic Link│  │  - boards   │  │  - Broadcast        │  │
│  │  (Email Only)│  │    table    │  │  - Presence         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## Features & Requirements

### F1: User Authentication

**Priority: P0 (Required)**

**Note**: Users are added manually by administrators via Supabase UI. This is a small-team application where manual user management is acceptable.

#### Requirements

- F1.1: Users can log in with email via magic link (passwordless)
- F1.2: Users receive magic link via email after submitting email address
- F1.3: Clicking magic link authenticates user and establishes session
- F1.4: Users can log out
- F1.5: All routes except /login and /auth/callback require authentication
- F1.6: Unauthenticated users are redirected to /login
- F1.7: Session persists across browser refreshes

#### Validation Requirements

- F1.8: Email must be valid format (RFC 5322 compliant)
- F1.9: Email field is required
- F1.10: Display validation errors inline on form submission
- F1.11: Show "Check your email" confirmation message after successful magic link request

#### Error Handling Requirements

- F1.12: Network errors show user-friendly message with retry option
- F1.13: Invalid email format shows validation error before submission
- F1.14: Magic link sending failures show user-friendly error message
- F1.15: Invalid or expired magic link tokens show appropriate error and redirect to login
- F1.16: Session expiration redirects to login with message
- F1.17: Server errors (500) show generic error message, log details server-side

#### Acceptance Criteria

- [ ] User can request magic link by entering email address
- [ ] "Check your email" message appears after successful request
- [ ] Clicking magic link in email authenticates user and redirects to dashboard
- [ ] Existing user can log in and see their session persist
- [ ] Logged out user cannot access /board/* routes
- [ ] Invalid email format shows validation error before submission
- [ ] Network failure during magic link request shows error with retry option
- [ ] Invalid/expired magic link token shows error and redirects to login
- [ ] Expired session redirects to login with informative message
- [ ] Attempting to access protected route while logged out redirects to login

---

### F2: Board Management

**Priority: P0 (Required)**

#### Requirements

- F2.1: Dashboard displays list of all boards
- F2.2: Each board card shows name, last updated date
- F2.3: Users can create a new board with a name
- F2.4: New boards get a unique URL slug
- F2.5: Users can delete a board (with confirmation dialog)
- F2.6: Clicking a board navigates to /board/[slug]

#### Validation Requirements

- F2.7: Board name must be 1-100 characters
- F2.8: Board name cannot be empty or only whitespace
- F2.9: Slug generation handles special characters and unicode
- F2.10: Duplicate slug generation appends number suffix (e.g., "board-2")

#### Error Handling Requirements

- F2.11: Network errors during board creation show error with retry
- F2.12: Invalid board name shows validation error before submission
- F2.13: Board not found (404) shows appropriate message and redirects to dashboard
- F2.14: Concurrent board deletion shows error if board no longer exists
- F2.15: Database constraint violations show user-friendly error

#### Data Model

```typescript
interface Board {
  id: string           // UUID
  slug: string         // URL-friendly unique identifier
  name: string         // User-provided name
  elements: object[]   // Excalidraw elements array
  app_state: object    // Excalidraw app state
  created_by: string   // User UUID
  created_at: Date
  updated_at: Date
}
```

#### Acceptance Criteria

- [ ] Dashboard loads and displays all boards
- [ ] Creating a board adds it to the list immediately
- [ ] Deleting a board removes it from the list
- [ ] Board slugs are unique and URL-safe
- [ ] Empty state shown when no boards exist
- [ ] Board name validation prevents empty or too-long names
- [ ] Duplicate board names generate unique slugs
- [ ] Attempting to access non-existent board shows 404 and redirects
- [ ] Deleting a board while another user is viewing it shows error on their next action
- [ ] Two users creating boards with same name simultaneously both succeed with unique slugs

---

### F3: Excalidraw Canvas

**Priority: P0 (Required)**

#### Requirements

- F3.1: Board page renders full-screen Excalidraw canvas
- F3.2: Canvas loads with saved elements and app state
- F3.3: All Excalidraw tools and features work normally
- F3.4: Canvas is responsive and fills viewport

#### Error Handling Requirements

- F3.5: Failed board load shows error message with retry option
- F3.6: Corrupted board data shows error and falls back to empty canvas
- F3.7: Excalidraw load failure shows error with reload option

#### Technical Constraints

- Excalidraw must be loaded client-side only (no SSR)
- Use dynamic import with `ssr: false`
- Handle loading state while component loads

#### Acceptance Criteria

- [ ] Board page shows Excalidraw canvas
- [ ] Previously saved drawings appear on load
- [ ] All drawing tools function correctly
- [ ] No hydration errors or SSR issues
- [ ] Failed board load shows error message
- [ ] Corrupted data gracefully falls back to empty canvas
- [ ] Large boards (1000+ elements) load without performance degradation

---

### F4: Auto-Save

**Priority: P0 (Required)**

#### Requirements

- F4.1: Changes auto-save to database
- F4.2: Save is debounced (5 seconds after last change)
- F4.3: Save includes both elements and appState
- F4.4: No save occurs if nothing changed
- F4.5: Visual indicator shows save status (optional but nice)

#### Error Handling Requirements

- F4.6: Save failures queue for retry (up to 3 attempts)
- F4.7: Persistent save failures show user notification
- F4.8: Network disconnection pauses saves and resumes on reconnect
- F4.9: Save timeout (30 seconds) cancels and shows error

#### Acceptance Criteria

- [ ] Drawing something and refreshing shows the drawing
- [ ] Rapid changes don't cause excessive API calls
- [ ] Network tab shows saves happening ~5s after drawing stops
- [ ] Save failures retry automatically up to 3 times
- [ ] Persistent save failures show user notification
- [ ] Network disconnection pauses saves and resumes automatically
- [ ] Save timeout shows error after 30 seconds

---

### F5: Real-time Collaboration

**Priority: P0 (Required)**

#### Requirements

- F5.1: Multiple users can view the same board simultaneously
- F5.2: Drawing changes broadcast to all connected users
- F5.3: Remote changes appear on local canvas in near real-time
- F5.4: Latency should be under 500ms for typical operations
- F5.5: Concurrent edits don't cause data loss

#### Technical Approach

```typescript
// Broadcast local changes
const onChange = (elements, appState) => {
  channel.send({
    type: 'broadcast',
    event: 'scene-update',
    payload: { elements, appState }
  })
}

// Receive remote changes
channel.on('broadcast', { event: 'scene-update' }, ({ payload }) => {
  excalidrawAPI.updateScene(payload)
})
```

#### Conflict Resolution Strategy

- **Element-level last-write-wins**: Each Excalidraw element has a unique ID. When two users modify the same element simultaneously, the last update received wins.
- **Simultaneous element creation**: New elements created by different users get unique IDs from Excalidraw, so both are preserved.
- **Element deletion conflicts**: If User A deletes an element while User B is modifying it, the deletion takes precedence (element is removed).
- **App state conflicts**: App state (zoom, pan, etc.) uses last-write-wins. This may cause minor visual jumps but is acceptable for small teams.
- **Optimistic updates**: Local changes appear immediately. Remote changes are applied when received, potentially overwriting local optimistic updates for the same element.
- **Reconnection handling**: On reconnection, full scene state is fetched from database to ensure consistency.

#### Error Handling Requirements

- F5.6: Realtime connection failures show indicator and attempt reconnection
- F5.7: Reconnection after disconnect fetches latest state from database
- F5.8: Broadcast failures are logged but don't block local drawing
- F5.9: Channel subscription failures show error and allow manual retry

#### Acceptance Criteria

- [ ] Open same board in two browser windows
- [ ] Drawing in one window appears in the other
- [ ] Both users can draw simultaneously
- [ ] Refresh either window and all changes persist
- [ ] Simultaneous edits to same element resolve correctly (last-write-wins)
- [ ] New elements created simultaneously by different users both appear
- [ ] Element deletion while another user edits it removes the element
- [ ] Realtime disconnection shows indicator and reconnects automatically
- [ ] Reconnection after disconnect syncs latest state correctly
- [ ] Network interruption doesn't cause data loss

---

### F6: Presence Indicators

**Priority: P1 (Important)**

#### Requirements

- F6.1: Show avatars/indicators for users currently on a board
- F6.2: Display user email or name
- F6.3: Update when users join or leave
- F6.4: Position in corner, non-intrusive

#### Technical Approach

```typescript
// Track presence
channel.on('presence', { event: 'sync' }, () => {
  const state = channel.presenceState()
  setOnlineUsers(Object.values(state).flat())
})

// Announce presence on join
channel.subscribe(async (status) => {
  if (status === 'SUBSCRIBED') {
    await channel.track({
      user_id: user.id,
      email: user.email,
      online_at: new Date().toISOString()
    })
  }
})
```

#### Acceptance Criteria

- [ ] Opening a board shows your own presence indicator
- [ ] Second user joining shows both indicators
- [ ] Closing tab removes that user's indicator
- [ ] Presence updates correctly when user's connection drops
- [ ] Multiple tabs from same user show as single presence indicator

---

## Logical Dependency Chain

The following order ensures foundational features are built first, enabling rapid iteration toward a usable frontend:

1. **Foundation Layer** (Must be first):
   - Project setup and configuration
   - Database schema and migrations
   - Supabase client setup
   - Basic authentication flow

2. **Core User Experience** (Enables visible progress):
   - Dashboard with board list (even if empty)
   - Board creation and navigation
   - Basic board view page structure

3. **Canvas Integration** (Core functionality):
   - Excalidraw integration
   - Canvas rendering and basic interaction
   - Load saved board data

4. **Persistence** (Data reliability):
   - Auto-save functionality
   - Save/load cycle verification

5. **Collaboration** (Real-time features):
   - Realtime channel setup
   - Broadcast and receive changes
   - Conflict resolution

6. **Enhancements** (Polish):
   - Presence indicators
   - Error handling improvements
   - UI polish

7. **Deployment** (Production readiness):
   - Docker configuration
   - Environment setup
   - Documentation

**Key Principle**: Get to a working single-user whiteboard as quickly as possible, then add collaboration and polish. This allows for early testing and validation of core functionality.

---

## Database Schema

### SQL Migration

```sql
-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- Boards table
create table boards (
  id uuid primary key default gen_random_uuid(),
  slug text unique not null,
  name text not null,
  elements jsonb not null default '[]',
  app_state jsonb not null default '{}',
  created_by uuid references auth.users(id) on delete set null,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Create index for slug lookups
create index boards_slug_idx on boards(slug);

-- Row Level Security
alter table boards enable row level security;

-- Policies: All authenticated users can CRUD all boards
create policy "Authenticated users can read all boards" 
  on boards for select 
  using (auth.role() = 'authenticated');

create policy "Authenticated users can insert boards" 
  on boards for insert 
  with check (auth.role() = 'authenticated');

create policy "Authenticated users can update all boards" 
  on boards for update 
  using (auth.role() = 'authenticated');

create policy "Authenticated users can delete boards" 
  on boards for delete 
  using (auth.role() = 'authenticated');

-- Auto-update updated_at timestamp
create or replace function update_updated_at()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

create trigger boards_updated_at
  before update on boards
  for each row execute function update_updated_at();
```

---

## Project Structure

```
/
├── app/
│   ├── layout.tsx                 # Root layout with providers
│   ├── page.tsx                   # Dashboard (board list)
│   ├── login/
│   │   └── page.tsx               # Login page (magic link)
│   ├── auth/
│   │   └── callback/
│   │       └── route.ts           # Magic link callback handler
│   └── board/
│       └── [slug]/
│           └── page.tsx           # Board view
├── components/
│   ├── auth/
│   │   └── AuthForm.tsx           # Magic link login form (email only)
│   ├── boards/
│   │   ├── BoardCard.tsx          # Board preview card
│   │   ├── BoardList.tsx          # Grid of board cards
│   │   └── CreateBoardDialog.tsx  # New board modal
│   ├── canvas/
│   │   ├── ExcalidrawWrapper.tsx  # Main canvas component
│   │   └── PresenceAvatars.tsx    # Online users display
│   └── ui/
│       ├── Button.tsx             # Shared button component
│       ├── Dialog.tsx             # Modal dialog
│       └── Input.tsx              # Form input
├── lib/
│   ├── supabase/
│   │   ├── client.ts              # Browser client
│   │   ├── server.ts              # Server client
│   │   └── middleware.ts          # Auth helpers
│   ├── actions/
│   │   └── boards.ts              # Server actions for CRUD
│   └── utils/
│       ├── slug.ts                # Slug generation
│       └── debounce.ts            # Debounce utility
├── middleware.ts                   # Next.js auth middleware
├── .env.local                      # Environment variables
├── Dockerfile                      # Production container
├── docker-compose.yml              # Docker orchestration
└── README.md                       # Setup instructions
```

---

## Environment Configuration

### Required Environment Variables

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

### Supabase Project Setup

1. Create new project at supabase.com
2. Navigate to SQL Editor
3. Run the migration SQL from Database Schema section
4. Copy project URL and anon key to .env.local
5. Enable Magic Link authentication in Authentication → Providers → Email
6. Configure redirect URL: `http://localhost:3000/auth/callback` (development)
7. Add users manually via Authentication → Users → Add user (email only, no password required)
8. Enable Realtime for the `boards` table (optional, for DB change subscriptions)

### Deployment Requirements

#### Docker Configuration

- **Dockerfile**: Multi-stage build for optimized production image
- **docker-compose.yml**: Includes Next.js app and optional local Supabase setup
- **Health check endpoint**: `/api/health` returns 200 when app is ready
- **Environment variables**: All required vars documented in README
- **Port configuration**: Default port 3000, configurable via env var

#### Production Environment Variables

```bash
# Required
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# Optional
PORT=3000
NODE_ENV=production
```

#### Migration Strategy

- Database migrations run manually via Supabase SQL Editor
- No automatic migration on app startup (Supabase handles this)
- Migration files documented in project README

#### Health Checks

- Health endpoint: `GET /api/health`
- Returns: `{ status: "ok", timestamp: "..." }`
- Used by Docker/Kubernetes for readiness probes

---

## Implementation Tasks

> **Note**: This section is provided as a reference example of how tasks might be organized. Task Master AI will automatically generate a comprehensive task breakdown from the PRD requirements. This section can be used to validate that the generated tasks align with the intended implementation approach.

### Phase 1: Project Setup

- [ ] Initialize Next.js 14 project with TypeScript and Tailwind
- [ ] Install dependencies: @excalidraw/excalidraw, @supabase/supabase-js, @supabase/ssr, use-debounce
- [ ] Set up Supabase clients (browser and server)
- [ ] Configure environment variables
- [ ] Create basic project structure

### Phase 2: Authentication

- [ ] Create auth form component (email-only for magic link)
- [ ] Build login page with magic link request
- [ ] Implement magic link callback handler route
- [ ] Implement Next.js middleware for route protection
- [ ] Add logout functionality
- [ ] Test auth flow end-to-end (email → magic link → login)

### Phase 3: Board Management

- [ ] Create Supabase migration and run in SQL editor
- [ ] Implement server actions for board CRUD
- [ ] Build dashboard page with board list
- [ ] Create BoardCard component
- [ ] Build CreateBoardDialog component
- [ ] Add delete board with confirmation
- [ ] Implement slug generation utility

### Phase 4: Canvas Integration

- [ ] Create ExcalidrawWrapper client component
- [ ] Implement dynamic import with SSR disabled
- [ ] Build board page that loads data and renders canvas
- [ ] Add loading state while Excalidraw loads
- [ ] Verify canvas fills viewport correctly

### Phase 5: Persistence

- [ ] Implement debounced auto-save on canvas change
- [ ] Wire up save to Supabase update
- [ ] Test save/load cycle
- [ ] Add save status indicator (optional)

### Phase 6: Real-time Collaboration

- [ ] Set up Supabase Realtime channel per board
- [ ] Implement broadcast on local changes
- [ ] Implement receive and apply remote changes
- [ ] Test with multiple browser windows
- [ ] Handle edge cases (reconnection, etc.)

### Phase 7: Presence

- [ ] Implement presence tracking on channel
- [ ] Create PresenceAvatars component
- [ ] Display online users on board page
- [ ] Test join/leave updates

### Phase 8: Polish & Deployment

- [ ] Add error handling and user feedback
- [ ] Create Dockerfile
- [ ] Create docker-compose.yml
- [ ] Write README with setup instructions
- [ ] Test deployment locally with Docker
- [ ] Deploy to production environment

---

## API Reference

### Server Actions

```typescript
// lib/actions/boards.ts

// Get all boards
async function getBoards(): Promise<Board[]>

// Get single board by slug
async function getBoard(slug: string): Promise<Board | null>

// Create new board
async function createBoard(name: string): Promise<Board>

// Update board content
async function updateBoard(
  slug: string, 
  data: { elements: object[], app_state: object }
): Promise<void>

// Delete board
async function deleteBoard(slug: string): Promise<void>
```

---

## Non-Functional Requirements

### Performance

- **Time to First Paint (TTFP)**: < 1.5 seconds
- **Time to Interactive (TTI)**: < 3 seconds
- **Initial page load**: < 3 seconds on 3G connection
- **Canvas interaction**: Feels instant (local-first rendering, < 50ms perceived latency)
- **Collaboration sync latency**: < 500ms for typical operations
- **Save operation**: Completes within 2 seconds under normal network conditions
- **Large board load**: Boards with 1000+ elements load within 5 seconds

### Security

- All routes protected by authentication
- RLS policies prevent unauthorized database access
- No sensitive data exposed in client bundle

### Reliability

- Auto-save prevents data loss
- Graceful handling of network disconnection
- Realtime reconnection on connection drop

### Scalability

- Designed for small teams (< 20 users)
- Single Supabase project sufficient
- No special infrastructure required

---

## Out of Scope

The following features are explicitly not included in this version:

- Per-board access permissions
- Board templates or duplication
- Export to image/PDF (Excalidraw has this built-in)
- Version history / undo across sessions
- Comments or chat
- Mobile-optimized UI
- Offline support
- Board folders or organization
- User profiles or settings
- Accessibility features (WCAG compliance) - basic keyboard navigation may be supported by Excalidraw, but not a project requirement

---

## Testing Strategy

### Unit Tests

- **Utilities**: Test slug generation, debounce function, validation helpers
- **Components**: Test UI components in isolation (Button, Dialog, Input)
- **Coverage target**: 80% for utility functions and shared components

### Integration Tests

- **Authentication flow**: Request magic link → Click link → Access protected route → Logout
- **Board CRUD**: Create → Read → Update → Delete board
- **Save/Load cycle**: Draw → Auto-save → Refresh → Verify persistence

### End-to-End Tests

- **Critical user flows**:
  - Magic link login flow (email submission → click link → authenticated)
  - Two users collaborating on same board simultaneously
  - Network disconnection and reconnection during collaboration
  - Board deletion while another user is viewing it

### Manual Testing Checklist

- [ ] Test with 2-5 concurrent users on same board
- [ ] Test with slow 3G network connection
- [ ] Test with intermittent network failures
- [ ] Test with very large boards (1000+ elements)
- [ ] Test browser refresh during active collaboration
- [ ] Test multiple browser tabs from same user

### Testing Tools

- **Unit/Integration**: Jest + React Testing Library
- **E2E**: Playwright or Cypress
- **Manual**: Browser DevTools network throttling

---

## Accessibility Considerations

### Current Scope

- Basic keyboard navigation (inherited from Excalidraw)
- Focus management for modals and dialogs
- Semantic HTML where applicable

### Out of Scope (v1)

- Full WCAG 2.1 AA compliance
- Screen reader optimization
- High contrast mode
- Keyboard-only navigation for all features

**Note**: Excalidraw may provide some accessibility features, but comprehensive a11y is not a requirement for the initial release. This can be addressed in future iterations.

---

## Success Metrics

1. **Functional**: All acceptance criteria pass
2. **Collaboration**: Two users can draw simultaneously without conflicts
3. **Reliability**: No data loss during normal usage
4. **Performance**: 
   - TTFP < 1.5s, TTI < 3s
   - Canvas interactions < 50ms perceived latency
   - Save operations < 2s
   - Collaboration sync < 500ms
5. **Deployable**: Can be deployed to production with Docker

---

## Appendix

### Useful Resources

- [Excalidraw Documentation](https://docs.excalidraw.com/)
- [Supabase Auth Docs](https://supabase.com/docs/guides/auth)
- [Supabase Realtime Docs](https://supabase.com/docs/guides/realtime)
- [Next.js App Router Docs](https://nextjs.org/docs/app)

### Future Enhancements

The following features are planned for future releases but not included in v1:

- **F1.7**: OAuth login with Google (magic link is now the primary auth method)
- **F2.7**: Board templates and duplication
- **F2.8**: Board folders and organization
- **F5.7**: Advanced conflict resolution (operational transformation)
- **F6.5**: User avatars and profiles
- **F7.1**: Export boards to image/PDF (beyond Excalidraw's built-in)
- **F7.2**: Version history and undo across sessions
- **F7.3**: Comments and annotations
- **F7.4**: Mobile-optimized UI
- **F7.5**: Offline support with sync
- **F7.6**: Per-board access permissions

### Key Code Patterns

#### Dynamic Import for Excalidraw

```typescript
const Excalidraw = dynamic(
  () => import('@excalidraw/excalidraw').then(mod => mod.Excalidraw),
  { ssr: false, loading: () => <div>Loading canvas...</div> }
)
```

#### Supabase Client Setup

```typescript
// lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

#### Debounced Save Pattern

```typescript
const saveToDb = useDebouncedCallback(async (elements, appState) => {
  await updateBoard(slug, { elements, app_state: appState })
}, 5000)
```
